package org.example.client.user;

import org.example.domain.ChatGroup;
import org.example.domain.ChatLog;
import org.example.domain.ChatMessage;
import org.example.domain.User;
import org.example.rmi.ChatLogService;
import org.example.rmi.ChatObserver;
import org.example.rmi.ChatService;
import org.example.rmi.UserService;

import javax.swing.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.util.List;

public class userDashBoard {
    private JPanel topPanel;
    private JPanel leftPane;
    private JPanel main;
    private JButton updateButton;
    private JButton chatButton;
    private JTabbedPane tabbedPane1;
    private JPanel updatePane;
    private JPanel chatPane;
    private JTextArea textArea1;
    private JTextField msgFeild;
    private JButton sendButton;
    private JLabel userName;
    private JScrollPane groupList;
    private JPanel groupButtonPanel; // panel inside groupList


    private ChatService chatService;
    private UserService userService;
    private ChatLogService logService;
    private ChatLog chatLog;
    private User user;
    private ChatGroup chatGroup;

    public userDashBoard(ChatService chatService, UserService userService, ChatLogService logService, ChatLog chatLog, User user) {
        this.chatService = chatService;
        this.userService = userService;
        this.logService = logService;
        this.chatLog = chatLog;
        this.user = user;

        loadUserGroups(user); // display all groups

        // auto-select first chat group if available
        try {
            List<ChatGroup> groups = userService.getGroupDataByUserId(user.getUser_id());
            if (!groups.isEmpty()) {
                chatGroup = groups.get(0);
            }
        } catch (RemoteException e) {
            e.printStackTrace();
        }
    }

    public void handle() throws Exception {

        userName.setText("Hello, "+user.getUsername() + "\uD83D\uDE09");
        ChatObserver observer = new ChatObserver() {
            public void notifyNewMessage(String message, int chatId) throws RemoteException {
                System.out.println("Int: "+chatId+"  Object: "+chatGroup.getChatId());
                if(chatId == chatGroup.getChatId()){

                    List<ChatMessage> messages = chatService.getAllChatMessages(chatGroup.getChatId());
                    for(ChatMessage msg : messages){
                        SwingUtilities.invokeLater(() -> {
                            if (!textArea1.getText().contains(msg.getMessage())) {
                                textArea1.append(msg.getMessage() + "\n");
                            }
                        });
                    }

                }

            }
        };

        // add observer to the list [add new user]
        ChatObserver stub = (ChatObserver) UnicastRemoteObject.exportObject(observer, 0);
        chatLog = logService.login(user.getUser_id());
        chatService.subscribe(user, stub, chatLog, chatGroup.getChatId());


        JFrame frame = new JFrame("User Dashboard");
        frame.setContentPane(main);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.pack();
        frame.setVisible(true);


        updateButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                tabbedPane1.setSelectedComponent(updatePane);
            }
        });
        chatButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                tabbedPane1.setSelectedComponent(chatPane);
            }
        });


        sendButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                try {
                    String msg = msgFeild.getText().trim();
                    if (!msg.isEmpty()) {
                        if (logService.isUserOnline(user.getUser_id())) {
                            chatService.sendMessage(msg, user, chatGroup.getChatId());
                        } else {
                            System.out.println("User session has ended. Cannot send message.");
                        }

                        if (msg.equalsIgnoreCase("Bye")) {
                            chatLog = logService.logout(user.getUser_id());
                            chatService.unsubscribe(user, stub, chatLog, chatGroup.getChatId());
                        }

                        msgFeild.setText("");
                    }
                } catch (RemoteException ex) {
                    ex.printStackTrace();
                }
            }
        });

        frame.addWindowListener(new java.awt.event.WindowAdapter() {
            @Override
            public void windowClosing(java.awt.event.WindowEvent windowEvent) {
                try {
                    chatLog = logService.logout(user.getUser_id());
                    if (chatLog != null) {
                        chatService.unsubscribe(user, stub, chatLog, chatGroup.getChatId());
                        System.out.println("User logged out and unsubscribed.");
                    }
                } catch (RemoteException e) {
                    e.printStackTrace();
                }
            }
        });

    }

    private void loadUserGroups(User user) {
        try {
            groupButtonPanel = new JPanel();
            groupButtonPanel.setLayout(new BoxLayout(groupButtonPanel, BoxLayout.Y_AXIS));
            groupList.setViewportView(groupButtonPanel);
            //List<String> groupNames = userService.getGroupDataByUserId(user.getUser_id());
            List<ChatGroup> groups = userService.getGroupDataByUserId(user.getUser_id());

            groupButtonPanel.removeAll(); // Clear existing buttons
            for (ChatGroup group : groups) {
                JButton groupBtn = new JButton(group.getChatName());
                groupBtn.addActionListener(e -> {
                    chatGroup = group;

                    // Clear previous messages
                    textArea1.setText("");

                    try {
                        List<ChatMessage> messages = chatService.getAllChatMessages(chatGroup.getChatId());
                        for (ChatMessage msg : messages) {
                            textArea1.append(msg.getMessage() + "\n");
                        }
                    } catch (RemoteException ex) {
                        ex.printStackTrace();
                    }

                    tabbedPane1.setSelectedComponent(chatPane);
                });

                groupButtonPanel.add(groupBtn);
            }
            groupButtonPanel.revalidate();
            groupButtonPanel.repaint();

        } catch (RemoteException e) {
            e.printStackTrace();
        }
    }


}
